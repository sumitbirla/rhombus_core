<%=  render partial: 'admin/shared/user_summary', locals: { user: @user } %>

<% mods = Rails.configuration.modules %>

<ul class="nav nav-tabs" role="tablist">
  <li class="<%= "active" if ["logins", "", nil].include? params[:q] %>"><a href="<%= admin_system_user_path(@user, q: "logins")%>" role="tab">Logins</a></li>
  <% if mods.include? :store %>
  <li class="<%= "active" if params[:q] == "orders" %>"><a href="<%= admin_system_user_path(@user, q: "orders")%>" role="tab">Orders</a></li>
  <% end %>
  
  <% if mods.include? :ticketing %>
  <li class="<%= "active" if params[:q] == "tickets" %>"><a href="<%= admin_system_user_path(@user, q: "tickets")%>" role="tab">Tickets</a></li>
  <% end %>
  
  <% if mods.include?  :cms%>
  <li class="<%= "active" if params[:q] == "pictures" %>"><a href="<%= admin_system_user_path(@user, q: "pictures")%>" role="tab">Photos</a></li>
  <li class="<%= "active" if params[:q] == "locations" %>"><a href="<%= admin_system_user_path(@user, q: "locations")%>" role="tab">Locations</a></li>
  <% end %>
  
  <% if mods.include? :billing %>
  <li class="<%= "active" if params[:q] == "cc" %>"><a href="<%= admin_system_user_path(@user, q: "cc")%>" role="tab">CC</a></li>
  <li class="<%= "active" if params[:q] == "payments" %>"><a href="<%= admin_system_user_path(@user, q: "payments")%>" role="tab">Payments</a></li>
  <li class="<%= "active" if params[:q] == "subs" %>"><a href="<%= admin_system_user_path(@user, q: "subs")%>" role="tab">Subscriptions</a></li>
  <% end %>
  
  <% if mods.include? :pbx %>
  <li class="<%= "active" if params[:q] == "dids" %>"><a href="<%= admin_system_user_path(@user, q: "dids")%>" role="tab">DID's</a></li>
  <li class="<%= "active" if params[:q] == "vm" %>"><a href="<%= admin_system_user_path(@user, q: "vm")%>" role="tab">Voicemail</a></li>
  <li class="<%= "active" if params[:q] == "cdr" %>"><a href="<%= admin_system_user_path(@user, q: "cdr")%>" role="tab">CDR</a></li>
  <% end %>
</ul>

<% if params[:q] == "orders" 
  orders = Order.where(user_id: params[:id]).where.not(status: "in cart").order(submitted: :desc).paginate(page: params[:page], per_page: 10) %>
  
  <%= will_paginate orders %>
  <table class="table table-striped table-condensed">
  	<tr>
  		<th>Order #</th>
      <th>Sales Channel</th>
  		<th>Date</th>
  		<th>Customer</th>
  		<th>Location</th>
  		<th>Amount</th>
  		<th>Status</th>
  	</tr>
  	<% orders.each do |order| %>
  	<tr>
  		<td><%= link_to order.id, admin_store_order_path(order) %></td>
        <td><%= order.sales_channel %></td>
  		<td><%= systime order.submitted if order.submitted%></td>
  		<td><%= order.shipping_name || order.billing_name %></td>
  		<td><%= order.shipping_city %>, <%= order.shipping_state %></td>
  		<td><%= number_to_currency(order.total) %></td>
  		<td><%= order_status(order) %></td>
  	</tr>
  	<% end %>
  </table>

<% elsif params[:q] == "tickets" %>

  <% cases = Case.where(user_id: params[:id]).order(created_at: :desc) %>

  <table class="table table-striped table-condensed">
  	<tr>
      <th>ID</th>
      <th>Received</th>
      <th>From</th>
      <th>Subject</th>
      <th>Status</th>
      <th>Priority</th>
      <th>Assigned to</th>
  	</tr>
  	<% cases.each do |c| %>
  	<tr class="<%= "light" if c.status == "closed" %>">
  		<td><%= link_to c.id, admin_ticketing_case_path(c) %></td>
      <td nowrap><%= systime c.received_at %></td>
      <td>
        <% if c.user_id %>
          <%= link_to c.user.name, admin_system_user_path(c.user_id) %>
        <% else %>
          <%= c.name %>
        <% end %>
      </td>
  		<td>
        <%= truncate c.subject, length: 40 %>
        <% unless c.attachments.blank? %>
          <i class="fa fa-paperclip"></i>
        <% end %>
      </td>
      <td><%= case_status_indicator c %></td>
      <td><%= case_priority_indicator c %></td>
  		<td><% unless c.assigned_to.nil? %>
  			<%= link_to c.assignee.name, admin_system_user_path(c.assigned_to) %>
  			<% else %>
  			- none -
  			<% end%>
  		</td>
  	</tr>
  	<% end %>
  </table>
  
<% elsif params[:q] == "pictures" %>

  <% pics = Picture.where(user_id: params[:id]).order(created_at: :desc) %>

  <% pics.each do |pic| %>
    <%= link_to edit_admin_cms_picture_path(pic) do %>
      <img src="<%= cdn_image_url pic.file_path, 100, 100, 0 %>" class="img-thumbnail" alt="<%= pic.caption %>" style="margin: 4px;">
    <% end %>
  <% end %>
  
<% elsif params[:q] == "locations" %>

  <% locations = Location.where(user_id: params[:id]).order(created_at: :desc).paginate(page: params[:page], per_page: 10) %>

  <%= will_paginate locations %>
  <table class="table table-striped table-condensed">
  	<tr>
  		<th>Name</th>
  		<th>Address</th>
      <th>Country</th>
  		<th>Created</th>
  	</tr>
  	<% locations.each do |loc| %>
  	<tr>
  		<td><%= link_to loc.name, admin_cms_location_path(loc) %></td>
  		<td><%= loc.to_text(newline: ", ", skip_country: true) %></td>
      <td><%= loc.country %></td>	
  		<td><%= systime loc.created_at %></td>	
    </tr>
  	<% end %>
  </table>
  
<% elsif params[:q] == "cc" %>

  <% payment_methods = PaymentMethod.where(user_id: params[:id]).order(created_at: :desc) %>

  <table class="table table-striped table-condensed">
    <tr>
      <th>Card Holder</th>
      <th>Number</th>
      <th>Brand</th>
      <th>Expiration</th>
      <th>Last Transaction</th>
      <th>Default ?</th>
    </tr>
    <% payment_methods.each do |pm| %>
    <tr>
      <td><%= link_to pm.cardholder_name, admin_billing_payment_method_path(pm) %></td>
      <td><%= pm.card_display %></td>
      <td><%= pm.card_brand.titlecase %></td>
      <td><%= pm.expiration_month %> / <%= pm.expiration_year %></td>
      <td>
       <% if pm.last_transaction_date %>
        <%= systime pm.last_transaction_date %>
       <% else %>
         -
       <% end %></td>
      <td><%= tick pm.default %></td>
    </tr>
    <% end %>
  </table>
  
<% elsif params[:q] == "subs" %>

  <% @user_packages = UserPackage.joins(:package)
                                .where("bill_packages.domain_id = #{cookies[:domain_id]}")
                                .where(recurr_status: 'A')
                                .includes(:package)
                                .paginate(page: params[:page], per_page: 10)
                                .order(recurr_date: :desc) %>

  <table class="table table-striped table-condensed">
    <tr>
      <th>ID</th>
      <th>Package</th>
      <th>Amount</th>
      <th>Rate</th>
      <th>Recurr Date</th>
      <th>Bill Attempts</th>
      <th>Status</th>
    </tr>
    <% @user_packages.each do |up| %>
    <tr>
      <td><%= link_to up.id.to_s, admin_billing_user_package_path(up) %></td>
      <td><%= link_to up.package.name, admin_billing_package_path(up.package) %></td>
      <td><%= number_to_currency(up.amount) %></td>
      <td><%= number_to_currency(up.rate) %></td>
      <td><%= sysdate up.recurr_date %></td>
      <td><%= up.bill_attempts %></td>
      <td><%= up.recurr_status %></td>
    </tr>
    <% end %>
  </table>
  
<% elsif params[:q] == "payments" %>

  <% 
    payments = Payment.where(user_id: params[:id]).order(created_at: :desc)
    balance = payments.sum(:amount) 
    payments = payments.paginate(page: params[:page], per_page: 10)
  %>

  <div style="margin: 10px;">
    <b>Balance:</b> <%= number_to_currency(balance) %>
  </div>

  <%= will_paginate payments %>
  <table class="table table-striped table-condensed">
    <tr>
      <th>ID</th>
      <th>Date</th>
      <th>Customer</th>
      <th>Item</th>
      <th>Method</th>
      <th>Memo</th>
      <th>Amount</th>
    </tr>
    <% payments.order('created_at DESC').each do |pmt| %>
    <tr>
      <td><%= pmt.id %></td>
      <td><%= systime pmt.created_at %></td>
      <td><%= tick pmt.customer %></td>
      <td>
      <% if pmt.payable_type == "order" %>
          <%= link_to "Order ##{pmt.payable_id}", admin_store_order_path(pmt.payable_id) %>
      <% elsif pmt.payable_type == "user_package" %>
          <%= link_to "Package: " + UserPackage.find(pmt.payable_id).package.name, admin_billing_user_package_path(pmt.payable_id) %>
      <% elsif pmt.payable_type == "user_service" %>
          <%= UserService.find(pmt.payable_id).service_type.name %>
      <% elsif pmt.payable_type == "shipment" %>
          <% shipment = Shipment.find_by(id: pmt.payable_id)%>
          <%= link_to "Shipment #{shipment}", admin_store_shipment_path(pmt.payable_id) %>
      <% elsif pmt.payable_type == "pbx_cdr" %>
          <%= link_to "Phone Call", admin_pbx_cdr_path(0, uuid: pmt.payable_id) %>
      <% end %>
      </td>
      <td><%= pmt.cc_number %></td>
      <td><%= pmt.memo %></td>
      <td><%= number_to_currency(pmt.amount, negative_format: "(%u%n)") %></td>
    </tr>
    <% end %>
  </table>
  
<% elsif params[:q] == "dids" %>

  <% dids = Did.where(user_id: params[:id]).paginate(page: params[:page], per_page: 10) %>

  <%= will_paginate dids %>
  <table class="table table-striped table-condensed">
    <tr>
      <th>Number</th>
      <th>Name</th>
      <th>Command</th>
      <th>SMS</th>
      <th>Source</th>
    </tr>
    <% dids.each do |d| %>
    <tr>
      <td><%= number_to_phone d.number %></td>
  		<td>
        <% unless d.name.nil? %>
          <%= d.name %>
        <% else %>
          <span class="light">- not set -</span>
        <% end %>
      </td>
      <td><code><%= d.app%> <%= d.app_data %></code></td>
      <td><%= tick d.sms %></td>
      <td><%= d.source.blank? ? '- unknown -' : d.source %></td> 
  		<td><%= d.status %></td>
    </tr>
    <% end %>
  </table>
  
<% elsif params[:q] == "vm" %>

  <% vm_messages = PbxVmMessage.where(user: params[:id]).order(created_epoch: :desc).paginate(page: params[:page], per_page: 10)  %>

  <%= will_paginate vm_messages %>
  <table class="table table-condensed table-striped messages">
    <tr>
      <th>Received</th>
      <th>User</th>
      <th>From</th>
      <th>In Folder</th>
      <th>Msg Length</th>
      <th>Flags</th>
      <th>Read Flags</th>
      <th>Forward By</th>
      <th></th>
    </tr>
    <% vm_messages.each do |msg| 
    		user = msg.username + '@' + msg.domain %>
    <tr>
      <td style="color: #666;" nowrap><%= Time.at(msg.created_epoch).strftime("%D %l:%M %P") %></td>
      <td><%= user %></td>
      <td><%= msg.cid_name %> <<%= msg.cid_number %>></td>
  	  <td><%= msg.in_folder %></td>
      <td><%= Time.at(msg.message_len).utc.strftime("%k:%M:%S") %></td>
      <td><%= msg.flags %></td>
      <td><%= msg.read_flags %></td>
      <td><%= msg.forwarded_by %></td>
      <td>
     	 	<a href="<%= msg.file_path.sub('/mnt/nfs1', '') %>" class="audio">listen</a>
      </td>
    </tr>
    <% end %>
  </table>
  
<% elsif params[:q] == "cdr" %>

  <% cdr_list = PbxCdr.where("variables.x_user_id" => params[:id]).desc("variables.start_epoch").paginate(page: params[:page], per_page: 20) %>

  <%= will_paginate cdr_list %>
  <table class="table table-condensed">
    <tr>
      <th>start</th>
  	  <th>direction</th>
      <th>ani</th>
      <th>dnis</th>
      <th>duration</th>
  	<% if Rails.configuration.modules.include?(:callcenter)%>
      <th>app</th>
  	<% end %>
      <th>agent</th>
      <th>hangup</th>
      <th class="actions"></th>
    </tr>
    <% cdr_list.each do |cdr| 
    		vars = cdr[:variables] 
  		caller = cdr[:callflow].last[:caller_profile] %>
    <tr>
      <td style="color: #666;" nowrap><%= Time.at(vars[:start_epoch]).strftime("%D %l:%M %P") %></td>
      <td><%= vars[:direction]  %></td>
  	  <td><%= number_to_phone caller[:ani], area_code: true  %></td>
      <td><%= number_to_phone caller[:destination_number], area_code: true %></td>
      <td><%= Time.at(vars[:duration]).utc.strftime("%k:%M:%S") %></td>
      <td><code><%= vars[:current_application] %> <%= vars[:current_application_data] %></code></td>
      <% if Rails.configuration.modules.include?(:callcenter)%>
  	  <td>
      <% unless vars[:cc_agent].blank? %>
        <%= URI.decode(vars[:cc_agent]) %>
      <% else %>
        -
      <% end %>
      </td>
  	  <% end %>
      <td style="font-size: 0.85em;"><%= vars[:hangup_cause] %></td>
  	  <td><%= link_to "view", admin_pbx_cdr_path(cdr._id) %></td>
    </tr>
    <% end %>
  </table>

<% else %>

  <% logins = Login.where(user_id: @user.id).paginate(page: params[:page], per_page: 10).order(timestamp: :desc) %>
  
  <%= will_paginate logins %>
  <table class="table table-striped table-condensed">
  	<tr>
  		<th>Timestamp</th>
      <th>Source</th>
  		<th>IP Address</th>
  		<th>Platform</th>
  		<th>Browser</th>
  	</tr>
  	<% logins.each do | login | 
  		user_agent = UserAgent.parse(login.user_agent)%>
  	<tr>
  		<td><%= systime login.timestamp %></td>
      <td><%= login.source %></td>
  		<td><%= login.ip_address %></td>
  		<td><%= user_agent.platform %></td>
  		<td><%= user_agent.browser %> <%= user_agent.version %></td>
  	</tr>
  	<% end %>
  </table>

<% end %>





<% content_for :title do %>
	Users: <%= @user.name %>
<% end %>


<% content_for :head do %>
  <style>
  ul.pagination { margin-top: 10px; }
  </style>
<% end %>

<% content_for :menu do
    render "admin/shared/system_menu"
end %>


<% content_for :breadcrumbs do %>
	<li><a href="#">System</a></li>
	<li><%= link_to "Users", admin_system_users_path %></li>
	<li class="active"><%= @user.name %></li>
<% end %>