<div class="pull-right">
    <%= link_to "products", admin_store_affiliate_products_path(affiliate_id: @affiliate.id), class: "btn btn-sm btn-default" %>
    <%= link_to "edit", edit_admin_system_affiliate_path(@affiliate), class: "btn btn-sm btn-default" %>
</div>
<h2><%= @affiliate.name %></h2>
<hr/>

<div class="arow">
	
	<div class="col-md-8">
		<table class="table table-bordered table-condensed summary">
		  <tr>
		    <td width="160">Name</td>
		    <td><%= @affiliate.name %> </td>
		  </tr>
		  <% unless @affiliate.slug.blank? %>
		  <tr>
		  	<td>Slug</td>
		    <td><%= @affiliate.slug %> </td>
		  </tr>
		  <% end %>
		  <% unless @affiliate.code.blank? %>
		  <tr>
		  	<td>Code</td>
		    <td><%= @affiliate.code %> </td>
		  </tr>
		  <% end %>
		  <% unless @affiliate.contact_person.blank? %>
		  <tr>
		  	<td>Contact person</td>
		    <td><%= @affiliate.contact_person %> </td>
		  </tr>
		  <% end %>
		  <tr>
		  	<td>Address</td>
		    <td><%= raw @affiliate.address_as_text(delimiter: "<br>") %> </td>
		  </tr>
		  <% unless @affiliate.phone.blank? %>
		  <tr>
		  	<td>Phone</td>
		    <td><a href="tel:<%= @affiliate.phone %>"><%= @affiliate.phone %></a></td>
		  </tr>
		  <% end %>
		  <% unless @affiliate.fax.blank? %>
		  <tr>
		  	<td>Fax</td>
		    <td><%= @affiliate.fax %> </td>
		  </tr>
		  <% end %>
		  <% unless @affiliate.website.blank? %>
		  <tr>
		  	<td>Website</td>
		    <td><%= link_to @affiliate.website, @affiliate.website %> </td>
		  </tr>
		  <% end %>
		  <% unless @affiliate.facebook_page.blank? %>
		  <tr>
		  	<td>Facebook</td>
		    <td><%= link_to @affiliate.facebook_page, @affiliate.facebook_page %> </td>
		  </tr>
		  <% end %>
		  <% unless @affiliate.payment_terms.blank? %>
		  <tr>
		  	<td>Payment terms</td>
		    <td><%= @affiliate.payment_terms %> </td>
		  </tr>
		  <% end %>
		  <% unless @affiliate.description.blank? %>
		  <tr>
		  	<td>Description</td>
		    <td><%= raw @affiliate.description.gsub("\n", "<br>") %> </td>
		  </tr>
		  <% end %>
		</table>
    
	</div>
	
	<div class="col-md-4">
		<h4>Logo</h4>
		<% unless @affiliate.logo.blank? %>
		<img src="<%= cdn_image_url(@affiliate.logo, 240, 240, 0)%>" alt="logo" class="img-polaroid" />
		<% end %>
		
		<hr/>
		
		<h4>Flags</h4>
		<% if @affiliate.active %>
		<span class="label label-success">active</span> &nbsp; 
		<% else %>
		<span class="label label-danger">disabled</span> &nbsp; 
		<% end %>

		<% if @affiliate.featured %>
		<span class="label label-warning">featured</span> &nbsp; 
		<% end %>
		
		<% if Rails.configuration.modules.include?('store') && AffiliateProduct.where(affiliate_id: @affiliate.id).count > 0 %>
		<span class="label label-info"><%= @affiliate.products.count %> products</span> &nbsp; 
		<% end %>
		
		<hr/>
		
		<% if @affiliate.categories.length > 0 %>
		<h4>Categories</h4>
		<ul>
			<% @affiliate.categories.each do |cat| %>
			<li><%= cat.name %></li>
			<% end %>
		</ul>
		<% end %>
	</div>
</div>


<div class="row">
  <div class="col-md-12">
    
    <% mods = Rails.configuration.modules %>
    
    <ul class="nav nav-tabs" role="tablist">
      <% if mods.include? :marketing %>
        <li role="presentation" class="<%= "active" if ["campaigns", "", nil].include? params[:q] %>"><a href="<%= admin_system_affiliate_path(@affiliate, q: "campaigns")%>" role="tab">Marketing Campaigns</a></li>
        <% if mods.include? :store %>
          <li role="presentation" class="<%= "active" if params[:q] == "orders" %>"><a href="<%= admin_system_affiliate_path(@affiliate, q: "orders")%>" role="tab">Orders</a></li>
        <% end %>
        <li role="presentation" class="<%= "active" if params[:q] == "payments" %>"><a href="<%= admin_system_affiliate_path(@affiliate, q: "payments")%>" role="tab">Payments</a></li>
      <% end %>
    </ul>
		
    
    <% if params[:q] == "orders" %>
    
      <%
        campaigns = AffiliateCampaign.where(affiliate_id: @affiliate.id)
        orders = Order.includes(:affiliate_campaign)
                      .where(affiliate_campaign_id: campaigns)
                      .where.not(status: "in cart")
                      .order(submitted: :desc)
                      .paginate(page: params[:page], per_page: 10) 
      %>
  
      <%= will_paginate orders %>
      <table class="table table-striped table-condensed">
      	<tr>
      		<th>Order #</th>
      		<th>Date</th>
      		<th>Customer</th>
      		<th>Location</th>
      		<th>Amount</th>
          <th>Earn</th>
      		<th>Status</th>
      	</tr>
      	<% orders.each do |order| %>
      	<tr>
      		<td><%= link_to order.id, admin_store_order_path(order) %></td>
      		<td><%= systime order.submitted if order.submitted%></td>
      		<td><%= order.shipping_name || order.billing_name %></td>
      		<td><%= order.shipping_city %>, <%= order.shipping_state %></td>
      		<td><%= number_to_currency(order.total) %></td>
          <td><%= number_to_currency(order.total * order.affiliate_campaign.sale_commission / 100.0) %></td>
      		<td><%= order_status(order) %></td>
      	</tr>
      	<% end %>
      </table>
      
      <div class="table-summary">
      	<%= number_with_delimiter(orders.total_entries) %> records
      </div>

    <% elsif params[:q] == "payments" %>
    
    <% payments = Payment.where(payable_type: "affiliate", payable_id: @affiliate.id).where("amount < 0.0").order(created_at: :desc).paginate(page: params[:page], per_page: 10) %>

    <%= will_paginate payments %>
    <table class="table table-striped table-condensed">
      <tr>
        <th>ID</th>
        <th>Date</th>
        <th>Memo</th>
        <th>Amount</th>
      </tr>
      <% payments.order('created_at DESC').each do |pmt| %>
      <tr>
        <td><%= pmt.id %></td>
        <td><%= systime pmt.created_at %></td>
        <td><%= pmt.memo%></td>
        <td><%= number_to_currency(pmt.amount, negative_format: "(%u%n)") %></td>
      </tr>
      <% end %>
    </table>

    <% else %>
        <% campaigns = AffiliateCampaign.where(affiliate_id: @affiliate.id).order(created_at: :desc)%>

    		<table class="table table-striped table-condensed">
    			<tr>
    				<th>Campaign</th>
    				<th class="text-center">Signup</th>
    				<th class="text-center">Sale</th>
    				<th class="text-center">Raw clicks</th>
    				<th class="text-center">Uniq. clicks</th>
    				<th class="text-center">Signups</th>
    				<th class="text-center">Orders</th>
            <th class="text-center">Conv. A</th>
            <th class="text-center">Conv. B</th>
            <th>Earn</th>
    			</tr>
    			<% campaigns.each do |campaign| 
            earning =  Order.where(affiliate_campaign_id: campaign.id)
                            .where.not(status: ["in cart", "cancelled"])
                            .sum(:total) * campaign.sale_commission / 100.0 
                            
            earning += campaign.signup_commission * campaign.signups
            %>
    			<tr>
    				<td><%= link_to campaign.name, edit_admin_marketing_affiliate_campaign_path(campaign) %></td>
    				<td class="text-center"><%= number_to_currency campaign.signup_commission %></td>
    				<td class="text-center"><%= campaign.sale_commission %>%</td>
    				<td class="text-center"><%= number_with_delimiter(campaign.raw_clicks) %></td>
    				<td class="text-center"><%= number_with_delimiter(campaign.unique_clicks) %></td>
    				<td class="text-center"><%= number_with_delimiter(campaign.signups) %></td>
    				<td class="text-center"><%= number_with_delimiter(campaign.orders) %></td>
            <td class="text-center"><%= (100.0 * campaign.signups / campaign.unique_clicks).round(1) %>%</td>
            <td class="text-center"><%= (100.0 * campaign.orders / campaign.unique_clicks).round(1) %>%</td>
            <td><%= number_to_currency(earning) %></td>
    			</tr>
    			<% end %>
    		</table>
    
    <% end %>
  </div>
</div>



<%= content_for :title do %>
	Affiliates: <%= @affiliate.name %>
<% end %>


<% content_for :menu do
    render "admin/shared/system_menu"
end %>

<% content_for :breadcrumbs do %>
	<li><a href="#">System</a></li>
	<li><%= link_to "Affiliates", admin_system_affiliates_path %></li>
	<li class="active"><%= @affiliate.name %></li>
<% end %>
